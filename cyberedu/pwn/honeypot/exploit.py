from pwn import *
import ctypes
from ctypes.util import find_library
import time

TARGET_TYPE = 'remote'
BINARY_PATH = './pwn_honeypot'
HOST = '34.40.105.109'
PORT = 32229

libc_name = find_library('c')
libc = ctypes.CDLL(libc_name)

def get_process():
    if TARGET_TYPE == 'local':
        return process(BINARY_PATH)
    else:
        return remote(HOST, PORT)

def solve():
    p = get_process()

    # 1. Sync RNG
    now = int(time.time())
    libc.srand(now)

    p.sendlineafter(b"What's your name?", b"Hacker")

    round_count = 0

    try:
        while True:
            round_count += 1

            thread_burn = libc.rand()

            attack_val = libc.rand() & 3

            log.info(f"Round {round_count} | Thread uses {thread_burn % 30} dmg | Predicting Main Attack: {attack_val}")

            p.sendline(b"2")
            p.recvuntil(b"Firewall Option:")
            p.sendline(b"1")

            p.recvuntil(b"Enter option:")
            p.sendline(b"3")

            output = p.recvuntil(b"Firewall Option:", drop=False).decode(errors='ignore')

            if "You won" in output or "flag" in output:
                print("\nwin")
                print(output) 
                print(p.recvall(timeout=1).decode(errors='ignore')) 
                break

            if "Game Over" in output:
                print("Failed: Game Over")
                break

            p.sendline(str(attack_val).encode())

    except EOFError:
        print("\n[!] Connection closed. Checking buffer for flag...")
        print(p.recvall(timeout=1).decode(errors='ignore'))
    except Exception as e:
        log.error(f"Error: {e}")

solve()